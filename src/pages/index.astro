---
import IndexLayout from "../layouts/IndexLayout.astro";
import Button from "../components/Button.astro";
import ProjectCard from "../components/ProjectCard.astro";
import BlogCard from "../components/BlogCard.astro";
import ProjectCarousel from "../components/ProjectCarousel.astro";
import { getCollection } from "astro:content";
import ConsolePresentation, {
  type AuthorPresentation,
} from "@/components/ConsolePresentation.vue";
import * as presentation from "../content/me.md";
import BackgroundAnimatedCanvas from "@/components/BackgroundAnimatedCanvas.astro";

// Get featured projects and recent blog posts
const allProjects = await getCollection("projects");
const featuredProjects = allProjects
  .filter((p) => p.data.featured)
  .sort((a, b) => a.data.order - b.data.order)
  .slice(0, 3);

const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const recentPosts = allPosts
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 3);
---

<IndexLayout
  title="Home"
  description="Developer portfolio of Alex Vig - Building modern web experiences"
>
  <!-- Presentation Section -->
  <section
    class="presentation-section bg-white min-h-screen flex flex-col items-center text-center justify-center px-4 py-12 gap-8 md:gap-24 overflow-x-hidden"
  >
    <h1
      class="text-5xl sm:text-6xl md:text-7xl lg:text-8xl font-sans text-black font-bold z-10 flex flex-wrap justify-center gap-x-[0.3em] gap-y-2"
    >
      <span class="title-word opacity-0">Welcome</span>
      <span class="title-word opacity-0">To</span>
      <span class="title-word opacity-0">My</span>
      <span class="title-word opacity-0">Portfolio</span>
    </h1>
    <div class="presentation-console opacity-0 z-10">
      <ConsolePresentation
        client:visible
        class="mx-auto shadow-2xl text-left"
        presentation={presentation.frontmatter as AuthorPresentation}
        manualStart={true}
      />
    </div>
    <BackgroundAnimatedCanvas
      src="/images/scramble-text.webp"
      frames={4}
      fps={6}
      pixelated={true}
    />
  </section>

  <!-- Projects Section -->
  <section
    style={"background-color: " + allProjects[0]?.data.heroColor[0] ||
      "#ffffff; color: " + allProjects[0]?.data.heroColor[1] ||
      "#000000"}
    class="projects-section flex flex-col items-center text-center justify-center px-4 py-16 md:py-32 gap-8 overflow-x-hidden"
  >
    <h1
      class="text-5xl sm:text-6xl md:text-7xl lg:text-8xl font-sans font-bold z-10 flex flex-wrap justify-center gap-x-[0.3em] gap-y-2 mb-2"
    >
      <span class="title-word opacity-0">Watch</span>
      <span class="title-word opacity-0">My</span>
      <span class="title-word opacity-0">Magic</span>
      <span class="title-word opacity-0">Tricks</span>
    </h1>

    <div class="carousel-wrapper opacity-0 w-full">
      <ProjectCarousel
        projects={allProjects.sort((a, b) => a.data.order - b.data.order)}
      />
    </div>
  </section>

  <script>
    import gsap from "gsap";

    const animateTitleWords = (section: Element): Promise<void> => {
      const words = section.querySelectorAll(".title-word");

      if (!words.length) return Promise.resolve();

      return new Promise((resolve) => {
        gsap.fromTo(
          words,
          { opacity: 0, y: 32 },
          {
            opacity: 1,
            y: 0,
            duration: 0.5,
            stagger: 0.12,
            ease: "power2.out",
            onComplete: resolve,
          },
        );
      });
    };

    const runPresentationAnimations = async (section: Element) => {
      // 1. Animate title words
      await animateTitleWords(section);

      // 2. Animate console wrapper (slide up + fade)
      const consoleWrapper = section.querySelector(".presentation-console");
      if (consoleWrapper) {
        await new Promise<void>((resolve) => {
          gsap.fromTo(
            consoleWrapper,
            { opacity: 0, y: 32 },
            {
              opacity: 1,
              y: 0,
              duration: 0.6,
              ease: "power2.out",
              onComplete: resolve,
            },
          );
        });

        // 3. Signal console to start typing
        window.dispatchEvent(new CustomEvent("console:start-typing"));
      }
    };

    const setupPresentationObserver = () => {
      const section = document.querySelector(".presentation-section");
      if (!section) return;

      let hasAnimated = false;

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting && !hasAnimated) {
              hasAnimated = true;
              runPresentationAnimations(section);
              observer.disconnect();
            }
          });
        },
        { threshold: 0.25 },
      );

      observer.observe(section);
    };

    // Setup observer on initial load
    setupPresentationObserver();

    // Re-setup on View Transitions navigation
    document.addEventListener("astro:page-load", setupPresentationObserver);

    const runProjectsAnimations = async (section: Element) => {
      await animateTitleWords(section);

      // Animate carousel wrapper
      const carouselWrapper = section.querySelector(".carousel-wrapper");
      if (carouselWrapper) {
        await new Promise<void>((resolve) => {
          gsap.fromTo(
            carouselWrapper,
            { opacity: 0, y: 40 },
            {
              opacity: 1,
              y: 0,
              duration: 0.7,
              ease: "power2.out",
              onComplete: resolve,
            },
          );
        });
      }
    };

    const setupProjectsObserver = () => {
      const section = document.querySelector(".projects-section");
      if (!section) return;

      let hasAnimated = false;

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting && !hasAnimated) {
              hasAnimated = true;
              runProjectsAnimations(section);
              observer.disconnect();
            }
          });
        },
        { threshold: 0.25 },
      );

      observer.observe(section);
    };

    // Setup observer on initial load
    setupProjectsObserver();

    // Listen for carousel change events to trigger animations
    window.addEventListener("carousel:project-change", (event: Event) => {
      const detail = (event as CustomEvent).detail;
      const colors = detail.colors || ["#ffffff", "#000000"];
      gsap.to(".projects-section", {
        backgroundColor: colors[0],
        color: colors[1],
        duration: 1,
        ease: "power2.out",
      });
    });

    // Re-setup on View Transitions navigation
    document.addEventListener("astro:page-load", setupProjectsObserver);
  </script>
</IndexLayout>

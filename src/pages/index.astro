---
import IndexLayout from "../layouts/IndexLayout.astro";
import Button from "../components/Button.astro";
import ProjectCard from "../components/ProjectCard.astro";
import BlogCard from "../components/BlogCard.astro";
import { getCollection } from "astro:content";
import ConsolePresentation, {
  type AuthorPresentation,
} from "@/components/ConsolePresentation.vue";
import * as presentation from "../content/me.md";
import BackgroundAnimatedCanvas from "@/components/BackgroundAnimatedCanvas.astro";

// Get featured projects and recent blog posts
const allProjects = await getCollection("projects");
const featuredProjects = allProjects
  .filter((p) => p.data.featured)
  .sort((a, b) => a.data.order - b.data.order)
  .slice(0, 3);

const allPosts = await getCollection("blog", ({ data }) => !data.draft);
const recentPosts = allPosts
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .slice(0, 3);
---

<IndexLayout
  title="Home"
  description="Developer portfolio of Alex Vig - Building modern web experiences"
>
  <!-- Presentation Section -->
  <section
    class="presentation-section bg-white h-screen flex flex-col items-center text-center justify-center px-4 gap-8 md:gap-24 overflow-x-hidden"
  >
    <h1
      class="text-5xl sm:text-6xl md:text-7xl lg:text-8xl font-sans text-black font-bold z-10"
    >
      <span class="title-word inline-block opacity-0 translate-y-8"
        >Welcome</span
      >
      <span class="title-word inline-block opacity-0 translate-y-8">To</span>
      <span class="title-word inline-block opacity-0 translate-y-8">My</span>
      <span class="title-word inline-block opacity-0 translate-y-8"
        >Portfolio</span
      >
    </h1>
    <div class="presentation-console opacity-0 translate-y-8 z-10">
      <ConsolePresentation
        client:load
        class="mx-auto shadow-2xl text-left"
        presentation={presentation.frontmatter as AuthorPresentation}
        manualStart={true}
      />
    </div>
    <BackgroundAnimatedCanvas
      src="/images/scramble-text.webp"
      frames={4}
      fps={6}
      pixelated={true}
    />
  </section>

  <!-- Projects Section -->
  <section
    class="projects-section bg-amber-500 h-screen flex flex-col items-center text-center justify-center px-4 gap-8 md:gap-24 overflow-x-hidden"
  >
    <h1
      class="text-5xl sm:text-6xl md:text-7xl lg:text-8xl font-sans text-white font-bold z-10"
    >
      <span class="title-word inline-block opacity-0 translate-y-8">Watch</span>
      <span class="title-word inline-block opacity-0 translate-y-8">My</span>
      <span class="title-word inline-block opacity-0 translate-y-8">Magic</span>
      <span class="title-word inline-block opacity-0 translate-y-8">Tricks</span
      >
    </h1>
  </section>

  <script>
    import { animate, stagger } from "motion";

    const animateTitleWords = async (section: Element) => {
      const words = section.querySelectorAll(".title-word");

      if (!words.length) return;

      return animate(
        words,
        { opacity: [0, 1], y: [32, 0] },
        { duration: 0.5, delay: stagger(0.12), easing: "ease-out" },
      ).finished;
    };

    const runPresentationAnimations = async (section: Element) => {
      // 1. Animate title words
      await animateTitleWords(section);

      // 2. Animate console wrapper (slide up + fade)
      const consoleWrapper = section.querySelector(".presentation-console");
      if (consoleWrapper) {
        await animate(
          consoleWrapper,
          { opacity: [0, 1], y: [32, 0] },
          { duration: 0.6, easing: "ease-out" },
        ).finished;

        // 3. Signal console to start typing
        window.dispatchEvent(new CustomEvent("console:start-typing"));
      }
    };

    const setupPresentationObserver = () => {
      const section = document.querySelector(".presentation-section");
      if (!section) return;

      let hasAnimated = false;

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting && !hasAnimated) {
              hasAnimated = true;
              runPresentationAnimations(section);
              observer.disconnect();
            }
          });
        },
        { threshold: 0.25 },
      );

      observer.observe(section);
    };

    // Setup observer on initial load
    setupPresentationObserver();

    // Re-setup on View Transitions navigation
    document.addEventListener("astro:page-load", setupPresentationObserver);

    const runProjectsAnimations = async (section: Element) => {
      await animateTitleWords(section);
    };

    const setupProjectsObserver = () => {
      const section = document.querySelector(".projects-section");
      if (!section) return;

      let hasAnimated = false;

      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting && !hasAnimated) {
              hasAnimated = true;
              runProjectsAnimations(section);
              observer.disconnect();
            }
          });
        },
        { threshold: 0.25 },
      );

      observer.observe(section);
    };

    // Setup observer on initial load
    setupProjectsObserver();

    // Re-setup on View Transitions navigation
    document.addEventListener("astro:page-load", setupProjectsObserver);
  </script>
</IndexLayout>
